### 哈希算法

#### 一、什么是哈希算法

1.定义

**将任意长度的二进制值串映射成固定长度的二进制值串**，这个映射的规则就是哈希算法，而通过原始数据映射之后得到的二进制值串就是哈希值。

2.如何设计一个优秀的哈希算法？

①单向性：

从哈希值不能反向推导出哈希值（所以哈希算法也叫单向哈希算法）。

②雪崩效应：

对输入敏感，哪怕原始数据只修改一个Bit，最后得到的哈希值也大不相同。

③散列冲突：

散列冲突的概率要很小，对于不同的原始数据，哈希值相同的概率非常小。

④执行效率：

哈希算法的执行效率要尽量高效，针对较长的文本，也能快速计算哈希值。

#### 二、常见应用

> 7个常见应用：安全加密、唯一标识、数据校验、散列函数；
>
> 负载均衡、数据分片、分布式存储。

##### 1.安全加密

①常用于加密的哈希算法：

- MD5：MD5 Message-Digest Algorithm，MD5消息摘要算法
- SHA：Secure Hash Algorithm，安全散列算法
- DES：Data Encryption Standard，数据加密标准
- AES：Advanced Encryption Standard，高级加密标准

②对用于加密的哈希算法，有两点格外重要，第一点是很难根据哈希值反向推导出原始数据，第二点是散列冲突的概率要小。
③在实际开发中要权衡破解难度和计算时间来决定究竟使用哪种加密算法。

##### 2.唯一标识

通过哈希算法计算出数据的唯一标识，从而用于高效检索数据。

如在海量的图库中搜索一张图片是否存在，可以给每一张图片取一个唯一标识（信息摘要）：从图片的二进制串的开头中间尾部各区100字节，放在一起进行哈希算法，将结果作为标识。然后通过它来进行检索。

如果继续提高检索效率，可以将图片的唯一标识和图片在图库中的路径信息存储在散列表中，当要查看某个图片是不是在图库中的时候，我们先通过哈希算法对这个图片取唯一标识，然后在散列表中查找是否存在这个唯一标识。

如果不存在，那就说明这个图片不在图库中；如果存在，我们再通过散列表中存储的文件路径，获取到这个已经存在的图片，跟现在要插入的图片做全量的比对，看是否完全一样。如果一样，就说明已经存在；如果不一样，说明两张图片尽管唯一标识相同，但是并不是相同的图片。

##### 3.数据校验

利用哈希算法对输入数据敏感的特点，可以对数据取哈希值，从而高效校验数据是否被篡改过。

如BT下载文件，是将文件分成好多块的，为了最后校验文件的一致性，可以将文件块分别取哈希值放在种子文件中，当文件下载完后，通过相同的哈希算法，对下载好的文件块逐一求哈希值，然后跟种子文件中保存的哈希值比对。如果不同，说明这个文件块不完整或者被篡改了，需要再重新从其他宿主机器上下载这个文件块。

##### 4.散列函数

散列函数中用到的哈希算法更加关注散列后的值能不能平均分布，以及散列函数的执行快慢。

#### 哈希算法在分布式系统中的应用

##### 1.负载均衡

会话粘滞(session sticky)的负载均衡算法：同一个用户，同一个客户端，一次会话的所有请求都发送到同一个服务器上

利用哈希算法可以实现一个会话粘滞(session sticky)的负载均衡算法。

如果直接将客户端的ip地址或者会话id与服务器编号做映射，根据客户端每次请求向映射表中查找服务器的编号，有一些缺点：

- 如果客户端很多，映射表会很大，浪费存储空间
- 客户端下线上线，服务器扩容，缩容都会导致映射失败，这样维护表的成本就会很大。

借助哈希算法，对客户端IP地址或者会花id计算哈希值，将得到的哈希值与服务器列表的大小进行取模运算，得到的值就是应该被路由到的服务器编号。这样就可以将同一个IP过来的所有请求都路由到同一个后端服务器上。

##### 2.数据分片

场景一：在海量搜索关键词中统计每个关键词被搜索的次数

方法：先对数据进行分片，采用多台机器并行处理，从搜索记录的文件中依次读取出每个搜索关键词，计算它的哈希值，将哈希值与机器数量n取模，得到的值就是这个关键词要被分配的机器编号。这样哈希值相同的关键词就被分到了同一个机器上，最后，将每个机器中出现的关键词的次数合并起来就是最后的结果。

以上，就是MapReduce的基本设计思想。（分治）

场景二：快速判断图片是否在图库中

假设现在我们的图库中有 1 亿张图片，很显然，在单台机器上构建散列表是行不通的。因为单台机器的内存有限，而 1 亿张图片构建散列表显然远远超过了单台机器的内存上限。

我们同样可以对数据进行分片，然后采用多机处理。我们准备 n 台机器，让每台机器只维护某一部分图片对应的散列表。我们每次从图库中读取一个图片，计算唯一标识，然后与机器个数 n 求余取模，得到的值就对应要分配的机器编号，然后将这个图片的唯一标识和图片路径发往对应的机器构建散列表。

当我们要判断一个图片是否在图库中的时候，我们通过同样的哈希算法，计算这个图片的唯一标识，然后与机器个数 n 求余取模。假设得到的值是 k，那就去编号 k 的机器构建的散列表中查找。

如果有一亿张图片构建散列表，大约需要的机器数量：

散列表中每个数据单元包含两个信息，哈希值和图片文件的路径。假设我们通过 MD5 来计算哈希值，那长度就是 128 比特，也就是 16 字节。文件路径长度的上限是 256 字节，我们可以假设平均长度是 128 字节。如果我们用链表法来解决冲突，那还需要存储指针，指针只占用 8 字节。所以，散列表中每个数据单元就占用 152 字节（这里只是估算，并不准确）。假设一台机器的内存大小为 2GB，散列表的装载因子为 0.75，那一台机器可以给大约 1000 万（2GB*0.75/152）张图片构建散列表。所以，如果要对 1 亿张图片构建索引，需要大约十几台机器。在工程中，这种估算还是很重要的，能让我们事先对需要投入的资源、资金有个大概的了解，能更好地评估解决方案的可行性。

##### 3.分布式存储

分布式存储是为了解决当服务器增多时，避免大量数据的迁移问题。

假设我们有 k 个机器，数据的哈希值的范围是[0, MAX]。我们将整个范围划分成 m 个小区间（m 远大于 k），每个机器负责 m/k 个小区间。当有新机器加入的时候，我们就将某几个小区间的数据，从原来的机器中搬移到新的机器中。这样，既不用全部重新哈希、搬移数据，也保持了各个机器上数据数量的均衡。除此之外，它还会借助一个虚拟的环和虚拟结点，更加优美地实现出来。

参考：白话解析：一致性哈希算法 consistent hashing   http://www.zsythink.net/archives/1182

##### 总结

- 在负载均衡应用中，利用哈希算法替代映射表，可以实现一个会话粘滞的负载均衡策略。
- 在数据分片应用中，通过哈希算法对处理的海量数据进行分片，多机分布式处理，可以突破单机资源的限制。
- 在分布式存储应用中，利用一致性哈希算法，可以解决缓存等分布式系统的扩容、缩容导致数据大量搬移的难题。

三、思考
1.如何防止数据库中的用户信息被脱库？你会如何存储用户密码这么重要的数据吗？

①使用MD5进行加密

②字典攻击：如果用户信息被“脱库”，黑客虽然拿到的是加密之后的密文，但可以通过“猜”的方式来破解密码，这是因为，有些用户的密码太简单。

③针对字典攻击，我们可以引入一个盐（salt），跟用户密码组合在一起，增加密码的复杂度。

2.哈希算法在区块链中的应用：SHA256



